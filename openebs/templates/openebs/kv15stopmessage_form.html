{% extends "base.html" %}
{% load floppyforms i18n %}

{% block content %}
<div class="row">
    <div class="col-lg-3">
        <h2>Lijn</h2>
        <div class="input-group">
            <span class="input-group-addon"><span class="glyphicon glyphicon-search"></span></span>
            <input type="text" class="form-control" id="line_search" placeholder="{% trans 'Lijnnummer of eindbestemming' %}">
        </div><br />
        <table class="table table-condensed table-hover">
            <thead>
                <tr>
                    <th>{% trans "Lijn" %}</th>
                    <th>{% trans "Eindbestemming" %}</th>
                </tr>
            </thead>
            <tbody id="rows">
                <tr>
                    <td colspan="2"><em>{% trans "Typ een eindbestemming in om te zoeken" %}</em></td>
                </tr>
            </tbody>
        </table>
    </div>
    <div class="col-lg-5">
        <h2>Haltes</h2>
        <table class="table openebs-stops table-hover" id="stops">

        </table>
    </div>
    <div class="col-lg-4">
        <h2>Bericht</h2>
        <form method="post" class="form" action="{% url "msg_add" %}">
            {% csrf_token %}
            {% form form using "floppyforms/layouts/bootstrap_vertical.html" %}
            <div class="form-group">
                <div class="col-lg-offset-2 col-lg-10">
                    <button type="submit" class="btn btn-primary">{% trans "Toevoegen" %}</button>
                </div>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block js_init %}
        $('#line_search').on('keyup', changeSearch);
        $( "body" ).on('click', ".line", showStops);
{% endblock %}

{% block js %}
    function changeSearch(event) {
        if ($("#line_search").val().length > 0) {
            $.ajax('/line/'+$("#line_search").val(), {
                success : writeList
            })
        }
    }

    function writeList(data, status) {
        validIds = []
        /* Add them all, as neccesary */
        for (key in data.object_list) {
            line = data.object_list[key]
            validIds.push('l'+line.pk)
            if (!$('#l'+line.pk).length) {
                row = '<tr class="line" id="l'+line.pk+'"><td>'+line.lineplanningnumber+ '</td>'
                row += '<td>'+line.headsign+'</td></tr>'
                $(row).hide().appendTo("#rows").fadeIn(999)
            }
        }
        /* Cleanup */
        $("#rows tr").each(function(index) {
            if ($.inArray($(this).attr('id'), validIds) == -1) {
                $(this).fadeOut(999).remove()
            }
        });
    }

    function showStops(event) {
        $("#rows tr.success").removeClass('success');
        $(".suc-icon").remove();
        $(this).addClass('success');
        $(this).children('td').eq(1).append('<span class="suc-icon pull-right glyphicon glyphicon-arrow-right"></span>');
        $.ajax('/line/'+$(this).attr('id').substring(1)+'/stops', {
                success : writeLine
        })
    }

    function writeLine(data, status) {
        $('#stops').fadeOut(200).empty();
        for (key in data.object.stop_map) {
            row = data.object.stop_map[key]
            if (row.left != null && row.right != null) {
                $('#stops').append('<tr><td>'+row.left.name+'</td><td class="img"><img src="/static/img/stop-both.png"></td><td>'+row.right.name+'</td></tr>');
            } else if (row.left != null) {
                $('#stops').append('<tr><td>'+row.left.name+'</td><td class="img"><img src="/static/img/stop-left.png"></td><td>&nbsp;</td></tr>');
            } else if (row.right != null) {
                $('#stops').append('<tr><td>&nbsp;</td><td class="img"><img src="/static/img/stop-right.png"></td><td>'+row.right.name+'</td></tr>');
            }
        }
        $('#stops').fadeIn(200);
    }
{% endblock %}
{% extends "base.html" %}
{% load i18n leaflet_tags static %}

{% block title %}Kaart{% endblock %}

{% block content_full_page %}
    <div class="container-fluid row">
        {% leaflet_map "map" callback="main_map_init" %}
    </div>
    <div id="autocomplete_holder">
        <input id="autocomplete" class="form-control" placeholder="Zoek een halte" >
    </div>
{% endblock %}

{% block extra_css %}
    {% leaflet_css %}
{% endblock %}

{% block extra_js %}
    {% leaflet_js %}
    <script type="text/javascript" src="{% static 'bower_components/handlebars/handlebars.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'bower_components/lodash/lodash.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'bower_components/typeahead.js/dist/typeahead.bundle.min.js' %}"></script>
    <script type="text/javascript">
        (function() {
            $('#map').css("height", ($(window).height() - $("nav.navbar").height()));
            resize();
            $(window).on("resize", resize);
            var remote = new Bloodhound({
                datumTokenizer: Bloodhound.tokenizers.obj.whitespace('value'),
                queryTokenizer: Bloodhound.tokenizers.whitespace,
                remote: {
                    url: '{% url 'stop_search_json' %}?q=%QUERY',
                    wildcard: '%QUERY',
                    filter: function (parsedResponse) {
                        return parsedResponse.object;
                    }
                }
            });
            {% verbatim %}
            $('#autocomplete').typeahead({ minLength: 2, highlight: true},
                    {
                        source: remote,
                        display: 'name',
                        templates: {
                            suggestion: Handlebars.compile('<div><strong>{{name}}</strong><br />' +
                                '<small>{{#if timingpointcode}} TPC {{timingpointcode}} {{/if}}' +
                                    '</small></div>')
                    }});
            {% endverbatim %}
            $('#autocomplete').bind('typeahead:select', function(ev, suggestion) {
                var dest;
                if (suggestion.timingpointcode in markerIndex) {
                    var feature = markerIndex[suggestion.timingpointcode];
                    var point = feature.geometry.coordinates
                    dest = [point[1], point[0]]
                    feature.openPopup();
                } else {
                    dest = suggestion.location
                    L.circleMarker(dest, {
                        radius: 10,
                        fillColor: "#ff0000",
                        color: "#fff",
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.8
                    }).addTo(leafletMap);
                }
                leafletMap.setView(dest, 16);
            });
        })();

        var mapmargin = 0;

        function resize(){
            if($(window).width()>=980){
                $('#map').css("height", ($(window).height() - mapmargin));
                $('#map').css("margin-top", -20);
            } else{
                $('#map').css("height", ($(window).height() - (mapmargin+12)));
                $('#map').css("margin-top",-21);
            }
        }

        var table_template;

        Handlebars.registerHelper('toLowerCase', function(str) {
            return str.toLowerCase();
        });

        Handlebars.registerHelper('shorten', function(str) {
            if (str.length > 65) {
                str = str.substring(0, 65) + "...";
            }
            return str;
        });

        Handlebars.registerHelper('makeStopMessageLink', function(num) {
            return "{% url "msg_view" 999 %}".replace("999", num);
        });

        function onMapFeature(feature, layer) {
            if (feature.properties && feature.properties.name) {
                var popup = L.popup().setContent("<em>Data wordt geladen...</em>")
                layer.bindPopup(popup);
                layer.on('click', function(e) {
                    var popup = e.target._popup;
                    $.get("{% url "msg_stop_json" 999 %}".replace("999", feature.properties.timingpointcode)).done(function(data) {
                        popup.setContent(table_template(_.merge(data, feature.properties)));
                        popup.update();
                    });
                });
                markerIndex[feature.properties.timingpointcode] = feature
            }
        }

        var halteMarkerOptions = {
            radius: 10,
            fillColor: "#ffff00",
            color: "#000",
            weight: 2,
            opacity: 1,
            fillOpacity: 0.8
        };

        var leafletMap;
        var markerIndex = {}

        function main_map_init (map, options) {
            leafletMap = map;
            map.setView(new L.LatLng(52.05, 4.32), 12);

            var dataurl = "{% url 'msg_geojson' %}";
            // Download GeoJSON via Ajax
            $.getJSON(dataurl, function (data) {
                // Add GeoJSON layer
                L.geoJson(data, {
                    onEachFeature: onMapFeature,
                    pointToLayer: function (feature, latlng) {
                        return L.circleMarker(latlng, halteMarkerOptions);
                    }
                }).addTo(map);
            });

            table_template = Handlebars.compile($("#table-template").html());
        }
    </script>
    {% verbatim %}
    <script id="table-template" type="text/x-handlebars-template">
        <h3>{{ name }}</h3>
        <strong>TPC:</strong> {{ timingpointcode }}
        <table class="table table-bordered table-striped">
            <tr><th><strong>Volgnummer</strong></th><th><strong>Inhoud</strong></th></tr>
            {{#each object}}
            <tr>
                <td><a href="{{ makeStopMessageLink kv15stopmessage__id }}"><img src="/static/img/logos/{{ toLowerCase kv15stopmessage__dataownercode }}.png" class="icon_small" />
                    - {{ kv15stopmessage__messagecodenumber }}</a>
                </td>
                <td>{{ shorten kv15stopmessage__messagecontent }}</td></tr>
            {{/each}}
        </table>
    </script>
    {% endverbatim %}
{% endblock %}
